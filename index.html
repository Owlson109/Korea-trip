<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>韓國冬日之旅 (可編輯版)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #e74c3c;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --light-text: #777;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-color); padding-bottom: 80px; }

        /* Header */
        header { background: linear-gradient(135deg, #1c2e4a 0%, #2c3e50 100%); color: white; padding: 20px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        header h1 { font-size: 1.5rem; margin-bottom: 5px; }

        /* Utility Buttons */
        .utility-bar { text-align: center; margin-top: 10px; }
        .btn-save { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 0.85rem; transition: 0.3s; }
        .btn-save:hover { background: white; color: var(--primary-color); }

        /* Date Nav */
        .date-nav-container { position: sticky; top: 0; background: white; z-index: 90; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 10px 0; }
        .date-nav { display: flex; overflow-x: auto; padding: 0 15px; gap: 10px; scrollbar-width: none; }
        .date-nav::-webkit-scrollbar { display: none; }
        .date-btn { flex: 0 0 auto; padding: 8px 15px; border-radius: 20px; background: #f0f2f5; border: none; cursor: pointer; min-width: 65px; transition: 0.3s; }
        .date-btn.active { background: var(--primary-color); color: white; transform: scale(1.05); }
        .date-btn .day { font-size: 0.75rem; display: block; }
        .date-btn .date { font-size: 1rem; font-weight: 700; display: block; }

        /* Timeline */
        .container { max-width: 800px; margin: 20px auto; padding: 0 20px; }
        .day-header { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
        .day-title { font-size: 1.3rem; color: var(--primary-color); border-left: 4px solid var(--accent-color); padding-left: 10px; }
        
        .timeline { position: relative; padding-left: 25px; min-height: 200px; }
        .timeline::before { content: ''; position: absolute; left: 6px; top: 0; bottom: 0; width: 2px; background: #ddd; }

        /* Cards */
        .event-card { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 20px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: 0.2s; border: 1px solid transparent; }
        .event-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .event-card::before { content: ''; position: absolute; left: -26px; top: 20px; width: 14px; height: 14px; background: white; border: 3px solid var(--primary-color); border-radius: 50%; z-index: 1; }
        .event-card.essential { border-left: 4px solid var(--accent-color); }
        .event-card.essential::before { border-color: var(--accent-color); background: var(--accent-color); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .time { color: var(--accent-color); font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .card-actions { opacity: 0.3; transition: 0.3s; }
        .event-card:hover .card-actions { opacity: 1; }
        .action-btn { background: none; border: none; cursor: pointer; color: #888; margin-left: 8px; font-size: 0.9rem; }
        .action-btn:hover { color: var(--primary-color); }
        .action-btn.delete:hover { color: red; }

        .event-title { font-size: 1.1rem; font-weight: 600; margin: 5px 0; color: var(--primary-color); }
        .event-desc { font-size: 0.9rem; color: var(--light-text); white-space: pre-line; }
        
        .tag { display: inline-block; padding: 2px 6px; background: #e1ecf4; color: #39739d; border-radius: 4px; font-size: 0.75rem; margin-top: 8px; }
        .tag.essential { background: #fadbd8; color: #c0392b; }

        /* Floating Add Button */
        .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--accent-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); cursor: pointer; transition: 0.3s; z-index: 99; border: none; }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        /* Modal (Popup) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal h3 { margin-bottom: 20px; color: var(--primary-color); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #555; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; }
        
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.95rem; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-primary { background: var(--primary-color); color: white; }

        .flight-info { background: #f8f9fa; border-radius: 6px; padding: 8px; margin-top: 5px; font-size: 0.85rem; color: #555; }
    </style>
</head>
<body>

<header>
    <h1><i class="fas fa-plane-departure"></i> 韓國冬日之旅</h1>
    <div class="utility-bar">
        <button onclick="downloadUpdatedHtml()" class="btn-save"><i class="fas fa-file-download"></i> 下載最新行程檔案</button>
        <button onclick="resetData()" class="btn-save" style="margin-left:5px; border-color: #ffcccc; color:#ffcccc;"><i class="fas fa-undo"></i> 重置</button>
    </div>
</header>

<div class="date-nav-container">
    <nav class="date-nav" id="dateNav"></nav>
</div>

<main class="container">
    <div class="day-header">
        <h2 id="currentDateDisplay" class="day-title"></h2>
    </div>
    <div id="timelineContainer" class="timeline"></div>
</main>

<button class="fab" onclick="openModal()"><i class="fas fa-plus"></i></button>

<div class="modal-overlay" id="eventModal">
    <div class="modal">
        <h3 id="modalTitle">新增行程</h3>
        <input type="hidden" id="eventId">
        
        <div class="form-group">
            <label>時間</label>
            <div style="display: flex; gap:10px;">
                <input type="time" id="eventTime" class="form-control">
                <input type="time" id="eventEndTime" class="form-control" placeholder="結束時間(選填)">
            </div>
        </div>

        <div class="form-group">
            <label>標題</label>
            <input type="text" id="eventTitle" class="form-control" placeholder="例如：逛弘大">
        </div>

        <div class="form-group">
            <label>描述 / 備註</label>
            <textarea id="eventDesc" class="form-control" rows="3" placeholder="詳細內容..."></textarea>
        </div>

        <div class="form-group">
            <label>類型</label>
            <select id="eventType" class="form-control">
                <option value="food">🍴 餐廳/美食</option>
                <option value="transport">🚌 交通/移動</option>
                <option value="hotel">🛏️ 飯店/住宿</option>
                <option value="shopping">🛍️ 購物</option>
                <option value="camera">📷 景點/拍照</option>
                <option value="flight">✈️ 飛機</option>
            </select>
        </div>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="eventEssential" style="width:20px; height:20px;">
            <label for="eventEssential" style="margin:0;">設為必要行程 (紅點標記)</label>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">取消</button>
            <button class="btn btn-primary" onclick="saveEvent()">儲存</button>
        </div>
    </div>
</div>

<script>
    // --- 初始數據 (如果沒有本地存檔，就用這個) ---
    const defaultData = {
        "2025-12-22": [
            { id: 1, time: "07:10", endTime: "11:40", title: "出發：前往首爾 (ICN)", desc: "HKG T1 -> ICN T1 (UO618)\nFare Class: X", type: "flight", essential: true },
            { id: 2, time: "13:00", title: "前往市區", desc: "搭乘 AREX 或 巴士前往飯店", type: "transport", essential: false }
        ],
        "2026-01-03": [
            { id: 3, time: "07:40", endTime: "10:35", title: "回程：返回香港 (HKG)", desc: "PUS -> HKG T1 (UO605)\nFare Class: W", type: "flight", essential: true }
        ]
    };

    // --- 全局變數 ---
    let scheduleData = {};
    let currentSelectedDate = "";
    
    // --- 系統初始化 ---
    function init() {
        loadData();
        setupDateNav();
    }

    // 1. 讀取數據 (優先讀取 LocalStorage)
    function loadData() {
        const stored = localStorage.getItem('korea_trip_2025');
        if (stored) {
            scheduleData = JSON.parse(stored);
        } else {
            scheduleData = JSON.parse(JSON.stringify(defaultData)); // Deep copy
        }
    }

    // 2. 儲存數據
    function saveData() {
        localStorage.setItem('korea_trip_2025', JSON.stringify(scheduleData));
        renderTimeline(currentSelectedDate);
    }

    // 重置數據
    function resetData() {
        if(confirm("確定要重置所有行程嗎？你自己新增的資料會消失喔！")) {
            localStorage.removeItem('korea_trip_2025');
            location.reload();
        }
    }

    // --- 日期導航 ---
    const startDate = new Date(2025, 11, 22);
    const endDate = new Date(2026, 0, 3);
    const daysOfWeek = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];

    function getDates(start, end) {
        const dates = [];
        let current = new Date(start);
        while (current <= end) {
            dates.push(new Date(current));
            current.setDate(current.getDate() + 1);
        }
        return dates;
    }

    function formatDateKey(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function setupDateNav() {
        const nav = document.getElementById('dateNav');
        const dates = getDates(startDate, endDate);
        
        dates.forEach((date, index) => {
            const dateKey = formatDateKey(date);
            const btn = document.createElement('button');
            btn.className = 'date-btn';
            btn.innerHTML = `<span class="day">${daysOfWeek[date.getDay()]}</span><span class="date">${date.getMonth()+1}/${date.getDate()}</span>`;
            btn.onclick = () => selectDate(dateKey, btn);
            
            nav.appendChild(btn);

            if(index === 0) selectDate(dateKey, btn);
        });
    }

    function selectDate(dateKey, btn) {
        currentSelectedDate = dateKey;
        document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

        const [y, m, d] = dateKey.split('-');
        const dateObj = new Date(y, m-1, d);
        document.getElementById('currentDateDisplay').innerHTML = `${m}月${d}日 <small style="font-size:0.6em; color:#777">(${daysOfWeek[dateObj.getDay()]})</small>`;

        renderTimeline(dateKey);
    }

    // --- 渲染時間軸 ---
    function renderTimeline(dateKey) {
        const container = document.getElementById('timelineContainer');
        container.innerHTML = '';
        
        const events = scheduleData[dateKey] || [];
        // 排序：按時間
        events.sort((a, b) => a.time.localeCompare(b.time));

        if (events.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:30px; color:#aaa;"><i class="fas fa-calendar-plus" style="font-size:2rem; margin-bottom:10px;"></i><br>點擊右下角 + 新增行程</div>`;
            return;
        }

        events.forEach(event => {
            const card = document.createElement('div');
            card.className = `event-card ${event.essential ? 'essential' : ''}`;
            
            let icon = 'fa-circle';
            if(event.type === 'flight') icon = 'fa-plane';
            if(event.type === 'food') icon = 'fa-utensils';
            if(event.type === 'hotel') icon = 'fa-bed';
            if(event.type === 'transport') icon = 'fa-bus';
            if(event.type === 'shopping') icon = 'fa-shopping-bag';
            if(event.type === 'camera') icon = 'fa-camera';

            const timeStr = event.endTime ? `${event.time} - ${event.endTime}` : event.time;
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="time"><i class="fas ${icon}"></i> ${timeStr}</div>
                    <div class="card-actions">
                        <button class="action-btn" onclick="openModal('${event.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete" onclick="deleteEvent('${event.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="event-title">${event.title}</div>
                <div class="event-desc">${event.desc.replace(/\n/g, '<br>')}</div>
                ${event.essential ? '<span class="tag essential">必要行程</span>' : ''}
            `;
            container.appendChild(card);
        });
    }

    // --- CRUD 邏輯 (新增/修改/刪除) ---
    
    function openModal(eventId = null) {
        const modal = document.getElementById('eventModal');
        const title = document.getElementById('modalTitle');
        
        // 清空/預填表單
        if (eventId) {
            title.innerText = "修改行程";
            const events = scheduleData[currentSelectedDate];
            const event = events.find(e => e.id == eventId);
            
            document.getElementById('eventId').value = event.id;
            document.getElementById('eventTime').value = event.time;
            document.getElementById('eventEndTime').value = event.endTime || '';
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventDesc').value = event.desc;
            document.getElementById('eventType').value = event.type;
            document.getElementById('eventEssential').checked = event.essential;
        } else {
            title.innerText = "新增行程";
            document.getElementById('eventId').value = '';
            document.getElementById('eventTime').value = '10:00';
            document.getElementById('eventEndTime').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDesc').value = '';
            document.getElementById('eventType').value = 'food';
            document.getElementById('eventEssential').checked = false;
        }

        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('eventModal').style.display = 'none';
    }

    function saveEvent() {
        const id = document.getElementById('eventId').value;
        const time = document.getElementById('eventTime').value;
        const endTime = document.getElementById('eventEndTime').value;
        const title = document.getElementById('eventTitle').value;
        const desc = document.getElementById('eventDesc').value;
        const type = document.getElementById('eventType').value;
        const essential = document.getElementById('eventEssential').checked;

        if (!title || !time) {
            alert("請至少填寫時間和標題");
            return;
        }

        if (!scheduleData[currentSelectedDate]) {
            scheduleData[currentSelectedDate] = [];
        }

        if (id) {
            // 修改
            const index = scheduleData[currentSelectedDate].findIndex(e => e.id == id);
            if (index !== -1) {
                scheduleData[currentSelectedDate][index] = { ...scheduleData[currentSelectedDate][index], time, endTime, title, desc, type, essential };
            }
        } else {
            // 新增
            const newEvent = {
                id: Date.now(), // 簡單的 ID 生成
                time, endTime, title, desc, type, essential
            };
            scheduleData[currentSelectedDate].push(newEvent);
        }

        saveData();
        closeModal();
    }

    function deleteEvent(id) {
        if(confirm("確定要刪除這個行程嗎？")) {
            scheduleData[currentSelectedDate] = scheduleData[currentSelectedDate].filter(e => e.id != id);
            saveData();
        }
    }

    // --- 下載最新 HTML 的黑魔法 ---
    function downloadUpdatedHtml() {
        // 1. 取得當前的 HTML 原始碼
        let htmlContent = document.documentElement.outerHTML;

        // 2. 將當前的 scheduleData 轉換成字串
        const dataString = JSON.stringify(scheduleData, null, 4);

        // 3. 使用正則表達式，把原始碼裡的 defaultData 替換成最新的數據
        // 這樣下載後的檔案，打開時 defaultData 就會是你現在編輯過的樣子
        const newHtml = htmlContent.replace(
            /const defaultData = \{[\s\S]*?\};/, 
            `const defaultData = ${dataString};`
        );

        // 4. 觸發下載
        const blob = new Blob([newHtml], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'korea_trip_updated.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // 啟動
    init();

    // 點擊 Modal 外圍關閉
    window.onclick = function(event) {
        const modal = document.getElementById('eventModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>

</body>
</html>